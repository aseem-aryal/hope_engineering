<?php
/* 
 * Generated by CRUDigniter v1.3 Beta 
 * www.crudigniter.com
 */
 
class General_detail extends CI_Controller
{
    function __construct()
    {
        parent::__construct();
        $this->load->model('General_detail_model');
        $this->load->model('bill_book_model');
	$this->load->model('Update_detail_model');
	$this->load->helper('form');
    }
    
    /*
     * Listing of general_details
     */
    public function index()
    {
        $data['general_details'] = $this->General_detail_model->get_all_general_details();
        $this->load->view('includes/header1.php');
	$this->load->view('includes/sidebar.php');
	$this->load->view('general_detail/index',$data);
        $this->load->view('includes/footer1.php');
    }
    /*Search*/
	function search(){
			$data['general_details']=$this->General_detail_model->get_search();
			$data['search_value']=$this->input->post('search');			
			$this->load->view('includes/header1.php');
			$this->load->view('includes/sidebar.php');
			$this->load->view('general_detail/index',$data);					
       			$this->load->view('includes/footer1.php');
	}
    /*
     * Adding new general_details
     */
    public function add()
    {   
        echo $this->input->post('insurer_id');
            $this->load->library('form_validation');

		$this->form_validation->set_rules('phone_number','Phone Number','alpha_numeric|max_length[10]');
		//$this->form_validation->set_rules('insurer_id','Insurer Id','required');
		$this->form_validation->set_rules('file_number','File Number','required');
		$this->form_validation->set_rules('reference_number','Reference Number','required');
		$this->form_validation->set_rules('contact_person_name','Contact Person Name','required');
		if($this->form_validation->run())     
        	{   
            	$params = array(
				'insurer_id' => $this->input->post('insurer_id'),
				'file_number' => $this->input->post('file_number'),
				'reference_number' => $this->input->post('reference_number'),
				'date_of_instruction' => $this->input->post('date_of_instruction'),
                                'date_of_instruction_nep' => $this->input->post('date_of_instruction_nep'),
				'vehicle_number' => $this->input->post('vehicle_number'),
				'contact_person_name' => $this->input->post('contact_person_name'),
				'phone_number' => $this->input->post('phone_number'),
				'place_of_visit' => $this->input->post('place_of_visit'),
				'type_of_case' => $this->input->post('type_of_case'),
				'recorded_by_uid' => $this->input->post('recorded_by_uid'),
				'case_status' => $this->input->post('case_status'),
				'update_ts' => $this->input->post('update_ts'),
            	);
		$general_details_id = $this->General_detail_model->add_general_details($params);		
		$file_number =$this->input->post('file_number');	
		$this->General_detail_model->get_post_general_details_id($file_number); //this is the general_deails_id from table
		redirect('index.php/general_detail/index');	
		}
        else
        {
            
            $this->load->model('insurer_lu_model');
            $data['insurer_list']=$this->insurer_lu_model->get_all_insurer_lu();
            
            $this->load->view('includes/header.php');
            $this->load->view('includes/sidebar.php');
            $this->load->view('general_detail/add',$data);
            $this->load->view('includes/footer.php');
	
        }
    }
    
    /*
     * Editing general_details
     */
    function edit($general_details_id)
    {   
        $this->load->library('form_validation');

		$this->form_validation->set_rules('phone_number','Phone Number','alpha_numeric|max_length[10]');
		//$this->form_validation->set_rules('insurer_id','Insurer Id','required');
		$this->form_validation->set_rules('file_number','File Number','required');
		$this->form_validation->set_rules('reference_number','Reference Number','required');
		$this->form_validation->set_rules('contact_person_name','Contact Person Name','required');
		
		if($this->form_validation->run())     
        {   
            $params = array(
				'insurer_id' => $this->input->post('insurer_id'),
				'file_number' => $this->input->post('file_number'),
				'reference_number' => $this->input->post('reference_number'),
				'date_of_instruction' => $this->input->post('date_of_instruction'),
                                'date_of_instruction_nep' => $this->input->post('date_of_instruction_nep'),
				'vehicle_number' => $this->input->post('vehicle_number'),
				'contact_person_name' => $this->input->post('contact_person_name'),
				'phone_number' => $this->input->post('phone_number'),
				'place_of_visit' => $this->input->post('place_of_visit'),
				'type_of_case' => $this->input->post('type_of_case'),
				'recorded_by_uid' => $this->input->post('recorded_by_uid'),
				'case_status' => $this->input->post('case_status'),
				'update_ts' => $this->input->post('update_ts'),
            );
            
            $this->General_detail_model->update_general_details($general_details_id,$params);            
            redirect('index.php/general_detail/index');
        }
        else
        {   
            $data['general_details'] = $this->General_detail_model->get_general_details($general_details_id);
            $this->load->model('insurer_lu_model');
            $data['insurer_list']=$this->insurer_lu_model->get_all_insurer_lu();
            
            $data['selected_insurer']=$this->insurer_lu_model->get_insurer_lu($data['general_details']['insurer_id']);
            
            #echo "<pre/>";
            #print_r($data);
            #die;is
                
            $this->load->view('includes/header.php');
            $this->load->view('includes/sidebar.php');
            $this->load->view('general_detail/edit',$data);
            $this->load->view('includes/footer.php');
	
        }
    }
    
	/*
	Updating general details
	*/
    function update($general_details_id)
    {   
        $this->load->library('form_validation');
	$data['general_details_id']=$general_details_id;
	//$this->form_validation->set_rules('posted_date','Date for Remarks','required');	
	//$this->form_validation->set_rules('remarks','Remarks','required');	
	$this->form_validation->set_rules('user','Assign User','required');
	$this->form_validation->set_rules('assign_date','Assign Date','required');
	$this->form_validation->set_rules('site','Site','required');
	$this->form_validation->set_rules('case_priority','Case Priority','required');
	$this->form_validation->set_rules('prioritize_from_date','Prioritize From Date','required');	
	$this->form_validation->set_rules('prioritize_to_date','Prioritize From Date','required');
	$this->form_validation->set_rules('update_status','Update Status','required');
	$this->form_validation->set_rules('date_of_submission','Date of Submission','required');

	$submit =$this->input->post('update');	
	if($this->form_validation->run())            
	{ 
	    $datas = array(
		'general_details_id'=> $general_details_id,			    	
		'remarks'=> $this->input->post('remarks'),
		'posted_date'=> $this->input->post('posted_date'),
   	    );					
            $params = array(
				'general_details_id'=> $general_details_id,
				'assign_user' => $this->input->post('user'),
				'assign_date' => $this->input->post('assign_date'),
				'site' => $this->input->post('site'),
				'case_priority' => $this->input->post('case_priority'),
				'prioritize_from_date' => $this->input->post('prioritize_from_date'),
				'prioritize_to_date' => $this->input->post('prioritize_to_date'),
				'update_status' => $this->input->post('update_status'),
				'consent_date' => $this->input->post('consent_date'),
				'date_of_submission' => $this->input->post('date_of_submission')
            );
            if ($this->input->post('remarks')!='' && $this->input->post('posted_date')!=''){
            $this->Update_detail_model->update_remarks($datas);
            }
	    $this->Update_detail_model->update_general_details($general_details_id,$params);   
            redirect('index.php/general_detail/index');
        }
        else
        {  
            $data['bill_book_status'] = $this->Update_detail_model->get_bill_book_status($general_details_id);
	    $data['driving_licence_status'] = $this->Update_detail_model->get_driving_licence_status($general_details_id);
	    $data['policy_paper_status'] = $this->Update_detail_model->get_policy_paper_status($general_details_id);
	    $data['route_permit_status'] = $this->Update_detail_model->get_route_permit_status($general_details_id);
	    $data['fitness_certificate_status'] = $this->Update_detail_model->get_fitness_certificate_status($general_details_id);
	    $data['bill_od_status'] = $this->Update_detail_model->get_bill_od_status($general_details_id);
	    $data['bill_tp_status'] = $this->Update_detail_model->get_bill_tp_status($general_details_id);
            $data['quotation_status'] = $this->Update_detail_model->get_bill_od_status($general_details_id);
	    $data['police_report_status'] = $this->Update_detail_model->get_bill_tp_status($general_details_id);
    	    $data['claim_form_status'] = $this->Update_detail_model->get_claim_form_status($general_details_id);
	//Added for Reference number not implemented
       	    //$data['reference_number_status'] = $this->Update_detail_model->get_reference_number_status($general_details_id);
	//Added content ends here for reference number
	   $data['remarks'] = $this->Update_detail_model->get_remarks($general_details_id); 
 	   $data['update_information']=$this->Update_detail_model->get_update_table($general_details_id);
           $update_params = array();
	   $update_params=  json_decode($data['update_information'],true);  
	   foreach($update_params as $key=>$item) {
		foreach ($item as $name=>$value){    		
			$data[$name]=$value;
		}
	   } 
	/*	   
	$data['assigned_user_date']=$this->Update_detail_model->get_assigned_user_date($general_details_id);		
	   $data['assigned_user_site']=$this->Update_detail_model->get_assigned_user_site($general_details_id);
	   $data['case_priority']=$this->Update_detail_model->get_case_priority($general_details_id);
	   $data['case_priority_from']==$this->Update_detail_model->get_case_priority_from($general_details_id);		
	   $data['case_priority_to']==$this->Update_detail_model->get_case_priority_to($general_details_update);		
	   $data['update_status']==$this->Update_detail_model->get_update_status($general_details_id);		
	   if($data['update_status'] == 3){
	   $data['consent_date']==$this->Update_detail_model->get_case_priority_to($general_details_id);		
	   }
	   $data['date_of_submission']==$this->Update_detail_model->get_date_of_submission($general_details_id);		
	  */ 
	    //$this->load->model('insurer_lu_model');
            //$data['insurer_list']=$this->insurer_lu_model->get_all_insurer_lu();
            
            //$data['selected_insurer']=$this->insurer_lu_model->get_insurer_lu($data['general_details']['insurer_id']);
            
            #echo "<pre/>";
            #print_r($data);
            #die;
                
            $this->load->view('includes/header.php');
            $this->load->view('includes/sidebar.php');
            $this->load->view('general_detail/update',$data);
            $this->load->view('includes/footer.php');
	
        }
    }


    /*
     * Deleting general_details
     */
    function remove($general_details_id)
    {
        $this->General_detail_model->delete_general_details($general_details_id);
        redirect('general_detail/index');
    }

	


}
